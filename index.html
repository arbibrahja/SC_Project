<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OLAP Intelligence Platform</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=JetBrains+Mono:wght@300;400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #0d0d0f;
    --paper: #f7f5f0;
    --cream: #ece9e2;
    --gold: #c9a84c;
    --gold-light: #f0d98a;
    --teal: #1a5f5f;
    --teal-light: #2a8a8a;
    --rust: #c94040;
    --slate: #4a5568;
    --muted: #8a8a8a;
    --border: rgba(0,0,0,0.1);
    --shadow: 0 4px 40px rgba(0,0,0,0.08);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* GRID BACKGROUND */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  /* SIDEBAR */
  .sidebar {
    position: fixed;
    left: 0; top: 0; bottom: 0;
    width: 260px;
    background: var(--ink);
    padding: 32px 0;
    z-index: 100;
    display: flex;
    flex-direction: column;
    border-right: 1px solid rgba(255,255,255,0.05);
  }

  .sidebar-logo {
    padding: 0 28px 32px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    margin-bottom: 24px;
  }

  .sidebar-logo .mark {
    width: 36px; height: 36px;
    background: var(--gold);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; margin-bottom: 12px;
    font-family: 'DM Serif Display', serif;
    color: var(--ink);
    font-style: italic;
  }

  .sidebar-logo h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 17px;
    color: #fff;
    line-height: 1.2;
    letter-spacing: -0.02em;
  }

  .sidebar-logo p {
    font-size: 11px;
    color: rgba(255,255,255,0.35);
    margin-top: 4px;
    font-family: 'JetBrains Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .nav-group { padding: 0 16px; margin-bottom: 8px; }
  .nav-label {
    font-size: 10px;
    color: rgba(255,255,255,0.25);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    padding: 0 12px 8px;
    font-family: 'JetBrains Mono', monospace;
  }

  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    color: rgba(255,255,255,0.5);
    font-size: 14px;
    font-weight: 400;
    transition: all 0.15s;
    margin-bottom: 2px;
  }
  .nav-item:hover { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.85); }
  .nav-item.active { background: var(--gold); color: var(--ink); font-weight: 600; }
  .nav-item .icon { font-size: 16px; width: 20px; text-align: center; flex-shrink: 0; }

  .sidebar-footer {
    margin-top: auto;
    padding: 20px 28px;
    border-top: 1px solid rgba(255,255,255,0.08);
  }
  .agent-status {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: rgba(255,255,255,0.3);
    line-height: 1.8;
  }
  .agent-dot {
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    background: #22c55e;
    margin-right: 6px;
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  /* MAIN CONTENT */
  .main {
    margin-left: 260px;
    min-height: 100vh;
    position: relative;
    z-index: 1;
  }

  /* TOP BAR */
  .topbar {
    padding: 28px 40px 20px;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    background: rgba(247,245,240,0.9);
    backdrop-filter: blur(8px);
    position: sticky; top: 0; z-index: 50;
  }

  .page-title {
    font-family: 'DM Serif Display', serif;
    font-size: 26px;
    letter-spacing: -0.03em;
    color: var(--ink);
  }
  .page-subtitle {
    font-size: 13px;
    color: var(--muted);
    margin-top: 4px;
    font-weight: 300;
  }

  .topbar-actions {
    display: flex; gap: 10px; align-items: center;
  }

  .badge {
    display: inline-flex; align-items: center;
    padding: 4px 12px;
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 100px;
    font-size: 11px;
    color: var(--slate);
    font-family: 'JetBrains Mono', monospace;
    font-weight: 400;
  }

  /* CONTENT */
  .content { padding: 32px 40px; }

  /* KPI CARDS */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 32px;
  }

  .kpi-card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
  .kpi-card::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 3px;
  }
  .kpi-card.gold::after { background: var(--gold); }
  .kpi-card.teal::after { background: var(--teal); }
  .kpi-card.rust::after { background: var(--rust); }
  .kpi-card.slate::after { background: var(--slate); }

  .kpi-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    font-family: 'JetBrains Mono', monospace;
    margin-bottom: 8px;
  }
  .kpi-value {
    font-family: 'DM Serif Display', serif;
    font-size: 28px;
    color: var(--ink);
    letter-spacing: -0.02em;
    line-height: 1;
  }
  .kpi-sub {
    font-size: 12px;
    color: var(--muted);
    margin-top: 6px;
  }

  /* CHAT INTERFACE */
  .chat-container {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow);
    margin-bottom: 32px;
  }

  .chat-header {
    background: var(--ink);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .chat-header h2 {
    font-family: 'DM Serif Display', serif;
    font-size: 16px;
    color: #fff;
    font-style: italic;
  }

  .chat-agents {
    display: flex; gap: 6px;
  }
  .chat-agent-tag {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    padding: 3px 8px;
    border-radius: 4px;
    background: rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.5);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .chat-agent-tag.active {
    background: var(--gold);
    color: var(--ink);
  }

  .chat-messages {
    height: 380px;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    scroll-behavior: smooth;
  }

  .chat-messages::-webkit-scrollbar { width: 4px; }
  .chat-messages::-webkit-scrollbar-track { background: transparent; }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--cream); border-radius: 2px; }

  .msg {
    max-width: 85%;
    animation: msgIn 0.3s ease;
  }
  @keyframes msgIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

  .msg.user { align-self: flex-end; }
  .msg.assistant { align-self: flex-start; }

  .msg-bubble {
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 14px;
    line-height: 1.5;
  }
  .msg.user .msg-bubble {
    background: var(--ink);
    color: #fff;
    border-bottom-right-radius: 4px;
  }
  .msg.assistant .msg-bubble {
    background: var(--cream);
    color: var(--ink);
    border-bottom-left-radius: 4px;
    border: 1px solid var(--border);
  }

  .msg-meta {
    font-size: 10px;
    color: var(--muted);
    margin-top: 4px;
    font-family: 'JetBrains Mono', monospace;
    padding: 0 4px;
  }
  .msg.user .msg-meta { text-align: right; }

  .msg-agents {
    display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;
  }
  .msg-agent-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 9px;
    padding: 2px 8px;
    border-radius: 3px;
    background: var(--teal);
    color: #fff;
    text-transform: uppercase;
  }

  /* RESULTS TABLE */
  .result-table-wrap {
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    margin-top: 10px;
    font-size: 12px;
  }
  .result-table {
    width: 100%;
    border-collapse: collapse;
  }
  .result-table th {
    background: var(--ink);
    color: rgba(255,255,255,0.7);
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 8px 12px;
    text-align: left;
  }
  .result-table td {
    padding: 7px 12px;
    border-bottom: 1px solid var(--border);
    color: var(--ink);
  }
  .result-table tr:last-child td { border-bottom: none; }
  .result-table tr:nth-child(even) td { background: rgba(0,0,0,0.02); }
  .result-table .num { font-family: 'JetBrains Mono', monospace; text-align: right; }

  /* CHAT INPUT */
  .chat-input-area {
    padding: 16px 24px;
    border-top: 1px solid var(--border);
    background: var(--paper);
    display: flex;
    gap: 10px;
    align-items: flex-end;
  }

  .chat-input {
    flex: 1;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    background: #fff;
    resize: none;
    min-height: 42px;
    max-height: 100px;
    transition: border-color 0.15s;
    color: var(--ink);
  }
  .chat-input:focus { outline: none; border-color: var(--teal); }
  .chat-input::placeholder { color: rgba(0,0,0,0.3); }

  .send-btn {
    background: var(--ink);
    color: #fff;
    border: none;
    border-radius: 10px;
    width: 42px; height: 42px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: background 0.15s, transform 0.1s;
    font-size: 18px;
    flex-shrink: 0;
  }
  .send-btn:hover { background: var(--teal); transform: scale(1.05); }
  .send-btn:disabled { background: var(--cream); color: var(--muted); cursor: not-allowed; transform: none; }

  /* QUICK QUERIES */
  .quick-queries {
    display: flex; flex-wrap: wrap; gap: 8px;
    padding: 12px 24px;
    border-top: 1px solid var(--border);
    background: rgba(0,0,0,0.02);
  }
  .quick-q {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 100px;
    padding: 5px 14px;
    font-size: 12px;
    cursor: pointer;
    color: var(--slate);
    transition: all 0.15s;
    font-weight: 400;
  }
  .quick-q:hover { background: var(--ink); color: #fff; border-color: var(--ink); }

  /* DATA SECTION */
  .section {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 24px;
    box-shadow: var(--shadow);
  }

  .section-header {
    padding: 18px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .section-title {
    font-family: 'DM Serif Display', serif;
    font-size: 16px;
    color: var(--ink);
    letter-spacing: -0.02em;
  }
  .section-tag {
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .section-body { padding: 24px; }

  /* MINI CHART (CSS-based bar chart) */
  .mini-chart { display: flex; flex-direction: column; gap: 10px; }
  .mini-bar-row { display: flex; align-items: center; gap: 10px; font-size: 13px; }
  .mini-bar-label { width: 120px; color: var(--slate); font-weight: 300; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .mini-bar-track { flex: 1; height: 8px; background: var(--cream); border-radius: 4px; overflow: hidden; }
  .mini-bar-fill { height: 100%; border-radius: 4px; transition: width 0.8s cubic-bezier(0.34,1.56,0.64,1); }
  .mini-bar-val { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--slate); width: 90px; text-align: right; flex-shrink: 0; }

  /* SQL VIEWER */
  .sql-block {
    background: #0d0d0f;
    color: #a8d8a8;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 14px 18px;
    border-radius: 8px;
    margin-top: 8px;
    line-height: 1.7;
    overflow-x: auto;
    white-space: pre;
  }

  /* FOLLOW-UPS */
  .followups {
    display: flex; flex-wrap: wrap; gap: 6px;
    margin-top: 8px;
  }
  .followup-btn {
    background: rgba(26,95,95,0.08);
    border: 1px solid rgba(26,95,95,0.2);
    border-radius: 6px;
    padding: 4px 10px;
    font-size: 11px;
    color: var(--teal);
    cursor: pointer;
    transition: all 0.15s;
  }
  .followup-btn:hover { background: var(--teal); color: #fff; }

  /* LOADING */
  .typing-dots { display: flex; gap: 4px; align-items: center; padding: 4px 0; }
  .typing-dots span {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--muted);
    animation: bounce 1.2s infinite;
  }
  .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
  .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes bounce { 0%,80%,100%{transform:translateY(0)} 40%{transform:translateY(-6px)} }

  /* API NOTICE */
  .api-notice {
    background: linear-gradient(135deg, rgba(201,168,76,0.1), rgba(201,168,76,0.05));
    border: 1px solid rgba(201,168,76,0.3);
    border-radius: 10px;
    padding: 14px 18px;
    font-size: 13px;
    color: var(--slate);
    margin-bottom: 24px;
    line-height: 1.5;
  }
  .api-notice strong { color: var(--gold); }

  /* RESPONSIVE */
  @media (max-width: 900px) {
    .sidebar { width: 200px; }
    .main { margin-left: 200px; }
    .topbar, .content { padding-left: 24px; padding-right: 24px; }
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
  }

  .loading-skeleton {
    background: linear-gradient(90deg, var(--cream) 25%, var(--paper) 50%, var(--cream) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 8px;
  }
  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

const API_BASE = 'http://localhost:8000';

const QUICK_QUESTIONS = [
  "Total revenue by region",
  "Compare 2023 vs 2024",
  "Top 5 countries by profit",
  "Drill down Q4 2024 by month",
  "Electronics in Europe",
  "Monthly trend 2024",
  "Profit margins by category",
  "Detect revenue anomalies",
];

const AGENTS = [
  { name: "DimensionNav", color: "#1a5f5f" },
  { name: "CubeOps", color: "#c9a84c" },
  { name: "KPICalc", color: "#c94040" },
  { name: "ReportGen", color: "#4a5568" },
  { name: "VizAgent", color: "#7c3aed" },
  { name: "AnomalyDet", color: "#059669" },
];

function formatNum(v) {
  if (typeof v !== 'number') return v;
  if (Math.abs(v) >= 1000000) return '$' + (v/1000000).toFixed(1) + 'M';
  if (Math.abs(v) >= 1000) return '$' + (v/1000).toFixed(0) + 'K';
  if (Number.isInteger(v)) return v.toLocaleString();
  return v.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 2});
}

function isNumeric(k) {
  return ['revenue', 'profit', 'cost', 'quantity', 'transactions', 'metric',
          'total_revenue', 'total_profit', 'total_qty', 'avg_margin',
          'avg_margin_pct', 'blended_margin_pct', 'yoy_growth_pct',
          'mom_change_pct', 'z_score', 'change', 'change_pct'].some(x => k.includes(x) || k === x);
}

function DataTable({ data, columns }) {
  if (!data || data.length === 0) return null;
  const cols = columns || Object.keys(data[0] || {});
  const displayData = data.slice(0, 20);

  return (
    <div className="result-table-wrap">
      <table className="result-table">
        <thead>
          <tr>{cols.map(c => <th key={c}>{c.replace(/_/g,' ')}</th>)}</tr>
        </thead>
        <tbody>
          {displayData.map((row, i) => (
            <tr key={i}>
              {cols.map(c => {
                const v = row[c];
                const num = isNumeric(c) && typeof v === 'number';
                return (
                  <td key={c} className={num ? 'num' : ''}>
                    {num ? formatNum(v) : (v === null || v === undefined ? '—' : String(v))}
                  </td>
                );
              })}
            </tr>
          ))}
          {data.length > 20 && (
            <tr><td colSpan={cols.length} style={{textAlign:'center',color:'#8a8a8a',fontStyle:'italic',fontSize:11,padding:'8px'}}>
              … {data.length - 20} more rows
            </td></tr>
          )}
        </tbody>
      </table>
    </div>
  );
}

function MiniBarChart({ data, labelKey, valueKey, color = '#1a5f5f' }) {
  if (!data || data.length === 0) return null;
  const max = Math.max(...data.map(d => d[valueKey] || 0));
  return (
    <div className="mini-chart">
      {data.slice(0, 8).map((d, i) => (
        <div className="mini-bar-row" key={i}>
          <div className="mini-bar-label" title={d[labelKey]}>{d[labelKey]}</div>
          <div className="mini-bar-track">
            <div className="mini-bar-fill"
              style={{ width: `${max > 0 ? (d[valueKey]/max*100) : 0}%`, background: color,
                       transitionDelay: `${i*60}ms` }} />
          </div>
          <div className="mini-bar-val">{formatNum(d[valueKey])}</div>
        </div>
      ))}
    </div>
  );
}

function AssistantMessage({ msg, onFollowup }) {
  const [showSQL, setShowSQL] = useState(false);
  const output = msg.primaryOutput;

  return (
    <div className="msg assistant">
      <div className="msg-bubble">
        <div style={{lineHeight:1.6}}>{msg.text}</div>

        {msg.agents && msg.agents.length > 0 && (
          <div className="msg-agents">
            {msg.agents.map((a, i) => (
              <span key={i} className="msg-agent-badge"
                style={{background: AGENTS.find(ag=>ag.name.toLowerCase().includes(a.toLowerCase().slice(0,6)))?.color || '#4a5568'}}>
                {a}
              </span>
            ))}
          </div>
        )}

        {output && output.data && output.data.length > 0 && (
          <DataTable data={output.data} columns={output.columns} />
        )}

        {output && output.sql && (
          <div style={{marginTop:8}}>
            <button onClick={() => setShowSQL(!showSQL)}
              style={{background:'none',border:'none',cursor:'pointer',
                      fontSize:11,color:'#8a8a8a',fontFamily:'JetBrains Mono,monospace',
                      textDecoration:'underline'}}>
              {showSQL ? 'hide' : 'show'} SQL
            </button>
            {showSQL && <div className="sql-block">{output.sql}</div>}
          </div>
        )}

        {msg.followups && msg.followups.length > 0 && (
          <div className="followups">
            {msg.followups.slice(0,3).map((f, i) => (
              <button key={i} className="followup-btn" onClick={() => onFollowup(f)}>
                {f}
              </button>
            ))}
          </div>
        )}
      </div>
      <div className="msg-meta">{msg.time}</div>
    </div>
  );
}

function Dashboard({ apiOnline, stats, regionData, categoryData }) {
  const colors = ['#1a5f5f','#c9a84c','#c94040','#4a5568'];

  return (
    <>
      {!apiOnline && (
        <div className="api-notice">
          <strong>⚡ Demo Mode</strong> — The backend API is not running. The chat interface shows
          simulated responses. To enable full functionality, start the FastAPI server with{' '}
          <code style={{fontFamily:'JetBrains Mono,monospace',fontSize:11}}>
            uvicorn backend.api.main:app --reload
          </code>{' '}
          and set your <strong>ANTHROPIC_API_KEY</strong> environment variable.
        </div>
      )}

      <div className="kpi-grid">
        {[
          { label: 'Total Revenue', value: stats ? formatNum(stats.total_revenue) : '—', color: 'gold', sub: '2022–2024' },
          { label: 'Total Profit', value: stats ? formatNum(stats.total_profit) : '—', color: 'teal', sub: 'Net earnings' },
          { label: 'Avg Margin', value: stats ? stats.avg_margin + '%' : '—', color: 'rust', sub: 'Blended margin' },
          { label: 'Avg Order', value: stats ? formatNum(stats.avg_order_value) : '—', color: 'slate', sub: 'Per transaction' },
        ].map(k => (
          <div key={k.label} className={`kpi-card ${k.color}`}>
            <div className="kpi-label">{k.label}</div>
            <div className="kpi-value">{k.value || <div className="loading-skeleton" style={{width:80,height:28}} />}</div>
            <div className="kpi-sub">{k.sub}</div>
          </div>
        ))}
      </div>

      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:24,marginBottom:24}}>
        <div className="section">
          <div className="section-header">
            <span className="section-title">Revenue by Region</span>
            <span className="section-tag">Geography</span>
          </div>
          <div className="section-body">
            {regionData ? (
              <MiniBarChart data={regionData} labelKey="region" valueKey="total_revenue" color={colors[0]} />
            ) : (
              <div style={{display:'flex',flexDirection:'column',gap:10}}>
                {[100,80,65,55].map((w,i)=>(
                  <div key={i} className="loading-skeleton" style={{height:8,width:`${w}%`}} />
                ))}
              </div>
            )}
          </div>
        </div>

        <div className="section">
          <div className="section-header">
            <span className="section-title">Revenue by Category</span>
            <span className="section-tag">Product</span>
          </div>
          <div className="section-body">
            {categoryData ? (
              <MiniBarChart data={categoryData} labelKey="category" valueKey="total_revenue" color={colors[1]} />
            ) : (
              <div style={{display:'flex',flexDirection:'column',gap:10}}>
                {[100,85,70,50].map((w,i)=>(
                  <div key={i} className="loading-skeleton" style={{height:8,width:`${w}%`}} />
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </>
  );
}

// -------------------------------------------------------
// MOCK API for demo mode
// -------------------------------------------------------
function mockResponse(query) {
  const q = query.toLowerCase();
  let text, data, sql, agents;

  if (q.includes('region')) {
    agents = ['CubeOps','ReportGen'];
    data = [
      {region:'North America',total_revenue:5200000,total_profit:1560000,avg_margin:30},
      {region:'Europe',total_revenue:4800000,total_profit:1344000,avg_margin:28},
      {region:'Asia Pacific',total_revenue:4200000,total_profit:1260000,avg_margin:30},
      {region:'Latin America',total_revenue:5100000,total_profit:1530000,avg_margin:30},
    ];
    sql = "SELECT g.region, ROUND(SUM(f.revenue),2) AS total_revenue\nFROM fact_sales f JOIN dim_geography g\nON f.geo_key = g.geo_key\nGROUP BY g.region ORDER BY total_revenue DESC";
    text = "Here's revenue broken down by region. North America and Latin America lead, followed by Europe and Asia Pacific.";
  } else if (q.includes('top')) {
    agents = ['KPICalc','ReportGen'];
    data = [
      {rank:1,dimension:'United States',metric:3400000,total_revenue:3400000,total_profit:980000},
      {rank:2,dimension:'Germany',metric:1900000,total_revenue:1900000,total_profit:532000},
      {rank:3,dimension:'Japan',metric:1700000,total_revenue:1700000,total_profit:510000},
      {rank:4,dimension:'United Kingdom',metric:1600000,total_revenue:1600000,total_profit:432000},
      {rank:5,dimension:'Brazil',metric:1500000,total_revenue:1500000,total_profit:375000},
    ];
    sql = "SELECT g.country AS dimension, ROUND(SUM(f.profit),2) AS metric\nFROM fact_sales f JOIN dim_geography g\nON f.geo_key = g.geo_key\nGROUP BY g.country\nORDER BY metric DESC LIMIT 5";
    text = "Top 5 countries by profit. The United States leads significantly, with Germany, Japan, UK, and Brazil following.";
  } else if (q.includes('compare') || q.includes('vs')) {
    agents = ['KPICalc','ReportGen'];
    data = [
      {period_a:'year2023',revenue_a:6200000,period_b:'year2024',revenue_b:6900000,change:700000,change_pct:11.3},
    ];
    sql = "SELECT d.year, ROUND(SUM(f.revenue),2) AS rev\nFROM fact_sales f JOIN dim_date d ON f.date_key=d.date_key\nGROUP BY d.year ORDER BY d.year";
    text = "Revenue grew 11.3% from 2023 to 2024 — an increase of $700K. Solid year-over-year performance across all regions.";
  } else if (q.includes('margin') || q.includes('profit')) {
    agents = ['KPICalc'];
    data = [
      {dimension:'Clothing',total_revenue:4500000,total_profit:2475000,avg_margin_pct:55,blended_margin_pct:55},
      {dimension:'Office Supplies',total_revenue:4800000,total_profit:2160000,avg_margin_pct:45,blended_margin_pct:45},
      {dimension:'Furniture',total_revenue:5200000,total_profit:1820000,avg_margin_pct:35,blended_margin_pct:35},
      {dimension:'Electronics',total_revenue:4900000,total_profit:1078000,avg_margin_pct:22,blended_margin_pct:22},
    ];
    sql = "SELECT p.category AS dimension, ROUND(AVG(f.profit_margin),2) AS avg_margin_pct\nFROM fact_sales f JOIN dim_product p ON f.product_key=p.product_key\nGROUP BY p.category ORDER BY avg_margin_pct DESC";
    text = "Clothing has the highest profit margins at 55%, followed by Office Supplies (45%). Electronics has the lowest margins at 22% — typical for competitive tech markets.";
  } else {
    agents = ['KPICalc','ReportGen'];
    data = [
      {metric:'Total Revenue', value:'$19,372,629'},
      {metric:'Total Profit', value:'$5,577,421'},
      {metric:'Avg Margin', value:'28.8%'},
      {metric:'Transactions', value:'10,000'},
    ];
    sql = "SELECT ROUND(SUM(revenue),2) AS total_revenue,\n       ROUND(SUM(profit),2) AS total_profit\nFROM fact_sales";
    text = "Here's a high-level overview of the dataset. Total revenue is ~$19.4M across 10,000 transactions from 2022–2024 with a blended 28.8% profit margin.";
  }

  return { text, data, sql, agents, followups: QUICK_QUESTIONS.slice(0,3) };
}

// -------------------------------------------------------
// MAIN APP
// -------------------------------------------------------
function App() {
  const [page, setPage] = useState('dashboard');
  const [messages, setMessages] = useState([
    {
      id: 1, role: 'assistant',
      text: 'Welcome to the OLAP Intelligence Platform. I have access to 6 specialized agents covering dimension navigation, cube operations, KPI calculation, report generation, visualization, and anomaly detection. Ask me any business question about the Global Retail Sales dataset.',
      time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
      agents: [], followups: QUICK_QUESTIONS.slice(0,3),
    }
  ]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [apiOnline, setApiOnline] = useState(false);
  const [stats, setStats] = useState(null);
  const [regionData, setRegionData] = useState(null);
  const [categoryData, setCategoryData] = useState(null);
  const msgEndRef = useRef(null);
  const inputRef = useRef(null);

  // Try to reach API
  useEffect(() => {
    fetch(`${API_BASE}/api/health`, {signal: AbortSignal.timeout(3000)})
      .then(r => r.json())
      .then(() => {
        setApiOnline(true);
        return Promise.all([
          fetch(`${API_BASE}/api/quick-stats`).then(r=>r.json()),
          fetch(`${API_BASE}/api/revenue-by-region`).then(r=>r.json()),
          fetch(`${API_BASE}/api/revenue-by-category`).then(r=>r.json()),
        ]);
      })
      .then(([s, reg, cat]) => { setStats(s); setRegionData(reg); setCategoryData(cat); })
      .catch(() => {
        setApiOnline(false);
        // Set mock stats for demo
        setStats({total_revenue:19372629,total_profit:5577421,avg_margin:28.8,avg_order_value:1937.26});
        setRegionData([
          {region:'North America',total_revenue:5200000},{region:'Latin America',total_revenue:5100000},
          {region:'Europe',total_revenue:4800000},{region:'Asia Pacific',total_revenue:4200000},
        ]);
        setCategoryData([
          {category:'Furniture',total_revenue:5200000},{category:'Electronics',total_revenue:4900000},
          {category:'Office Supplies',total_revenue:4800000},{category:'Clothing',total_revenue:4500000},
        ]);
      });
  }, []);

  useEffect(() => {
    msgEndRef.current?.scrollIntoView({behavior:'smooth'});
  }, [messages]);

  const sendMessage = useCallback(async (q) => {
    const query = (q || input).trim();
    if (!query || loading) return;
    setInput('');

    const userMsg = {
      id: Date.now(), role: 'user', text: query,
      time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})
    };
    setMessages(prev => [...prev, userMsg]);
    setLoading(true);

    try {
      let result;
      if (apiOnline) {
        const resp = await fetch(`${API_BASE}/api/chat`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({query}),
        });
        const data = await resp.json();

        // Find primary output (first with data)
        const primaryOutput = data.outputs?.find(o => o.data && o.data.length > 0);

        result = {
          text: data.narrative || 'Analysis complete.',
          primaryOutput,
          agents: data.steps_executed?.map(s => s.agent) || [],
          followups: data.suggested_followups || [],
        };
      } else {
        await new Promise(r => setTimeout(r, 900)); // simulate latency
        const mock = mockResponse(query);
        result = {
          text: mock.text,
          primaryOutput: { data: mock.data, columns: Object.keys(mock.data?.[0]||{}), sql: mock.sql },
          agents: mock.agents,
          followups: mock.followups,
        };
      }

      setMessages(prev => [...prev, {
        id: Date.now(), role: 'assistant',
        text: result.text,
        primaryOutput: result.primaryOutput,
        agents: result.agents,
        followups: result.followups,
        time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
      }]);
    } catch (err) {
      setMessages(prev => [...prev, {
        id: Date.now(), role: 'assistant',
        text: `Error: ${err.message}`,
        agents: [], followups: [],
        time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
      }]);
    } finally {
      setLoading(false);
    }
  }, [input, loading, apiOnline]);

  const handleKey = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  };

  const NAV = [
    { id: 'dashboard', icon: '◈', label: 'Dashboard' },
    { id: 'chat', icon: '⬡', label: 'AI Analysis' },
    { id: 'agents', icon: '⬢', label: 'Agents' },
    { id: 'schema', icon: '◇', label: 'Schema' },
  ];

  return (
    <>
      <div className="sidebar">
        <div className="sidebar-logo">
          <div className="mark">Ω</div>
          <h1>OLAP Intelligence<br/>Platform</h1>
          <p>Multi-Agent BI System</p>
        </div>

        <div className="nav-group">
          <div className="nav-label">Navigation</div>
          {NAV.map(n => (
            <div key={n.id} className={`nav-item ${page===n.id?'active':''}`}
              onClick={() => setPage(n.id)}>
              <span className="icon">{n.icon}</span>
              {n.label}
            </div>
          ))}
        </div>

        <div className="sidebar-footer">
          <div className="agent-status">
            {AGENTS.map(a => (
              <div key={a.name}>
                <span className="agent-dot" style={{background: a.color}} />
                {a.name}
              </div>
            ))}
          </div>
        </div>
      </div>

      <div className="main">
        <div className="topbar">
          <div>
            <div className="page-title">
              {page==='dashboard' && 'Executive Dashboard'}
              {page==='chat' && 'AI Analysis'}
              {page==='agents' && 'Agent Registry'}
              {page==='schema' && 'Star Schema'}
            </div>
            <div className="page-subtitle">Global Retail Sales · 10,000 transactions · 2022–2024</div>
          </div>
          <div className="topbar-actions">
            <span className="badge">{apiOnline ? '● API Online' : '○ Demo Mode'}</span>
          </div>
        </div>

        <div className="content">

          {/* DASHBOARD */}
          {page==='dashboard' && (
            <Dashboard apiOnline={apiOnline} stats={stats} regionData={regionData} categoryData={categoryData} />
          )}

          {/* CHAT */}
          {(page==='chat' || page==='dashboard') && (
            <div className="chat-container">
              <div className="chat-header">
                <h2>Business Intelligence Assistant</h2>
                <div className="chat-agents">
                  {AGENTS.map(a => (
                    <span key={a.name} className="chat-agent-tag"
                      style={loading ? {background: a.color, color: '#fff'} : {}}>
                      {a.name}
                    </span>
                  ))}
                </div>
              </div>

              <div className="quick-queries">
                {QUICK_QUESTIONS.map((q, i) => (
                  <button key={i} className="quick-q" onClick={() => sendMessage(q)}>{q}</button>
                ))}
              </div>

              <div className="chat-messages">
                {messages.map(msg => (
                  msg.role === 'user' ? (
                    <div key={msg.id} className="msg user">
                      <div className="msg-bubble">{msg.text}</div>
                      <div className="msg-meta">{msg.time}</div>
                    </div>
                  ) : (
                    <AssistantMessage key={msg.id} msg={msg} onFollowup={sendMessage} />
                  )
                ))}
                {loading && (
                  <div className="msg assistant">
                    <div className="msg-bubble">
                      <div className="typing-dots">
                        <span/><span/><span/>
                        <span style={{marginLeft:8,fontSize:11,color:'#8a8a8a',fontFamily:'JetBrains Mono,monospace'}}>
                          agents processing…
                        </span>
                      </div>
                    </div>
                  </div>
                )}
                <div ref={msgEndRef} />
              </div>

              <div className="chat-input-area">
                <textarea
                  ref={inputRef}
                  className="chat-input"
                  value={input}
                  onChange={e => setInput(e.target.value)}
                  onKeyDown={handleKey}
                  placeholder="Ask a business question… (Enter to send)"
                  rows={1}
                />
                <button className="send-btn" onClick={() => sendMessage()} disabled={!input.trim() || loading}>
                  ↑
                </button>
              </div>
            </div>
          )}

          {/* AGENTS PAGE */}
          {page==='agents' && (
            <div className="section">
              <div className="section-header">
                <span className="section-title">Agent Registry</span>
                <span className="section-tag">6 Active Agents</span>
              </div>
              <div className="section-body">
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(300px,1fr))',gap:16}}>
                  {[
                    {
                      name:'DimensionNavigator', tag:'Agent 1', color:'#1a5f5f',
                      description:'Navigates OLAP hierarchies via drill-down and roll-up across Time, Geography, and Product dimensions.',
                      ops:['drill_down','roll_up','group'],
                    },
                    {
                      name:'CubeOperations', tag:'Agent 2', color:'#c9a84c',
                      description:'Performs OLAP cube manipulations: Slice (single-dimension filter), Dice (multi-filter), Pivot, and Drill-Through.',
                      ops:['slice','dice','pivot','drill_through'],
                    },
                    {
                      name:'KPICalculator', tag:'Agent 3', color:'#c94040',
                      description:'Computes business KPIs including YoY growth, MoM change, period comparisons, Top-N rankings, and margin analysis.',
                      ops:['yoy_growth','mom_change','compare_periods','top_n','profit_margins'],
                    },
                    {
                      name:'ReportGenerator', tag:'Agent 4', color:'#4a5568',
                      description:'Formats results into polished reports with totals rows, executive narratives, and monthly trend reports.',
                      ops:['executive_summary','trend_report','format_table'],
                    },
                    {
                      name:'Visualization', tag:'Optional', color:'#7c3aed',
                      description:'Selects optimal chart types and builds Plotly-compatible chart configurations for any data shape.',
                      ops:['visualize'],
                    },
                    {
                      name:'AnomalyDetection', tag:'Optional', color:'#059669',
                      description:'Detects statistical anomalies using Z-score and IQR methods across time periods and product dimensions.',
                      ops:['monthly_anomaly','product_anomaly'],
                    },
                  ].map(a => (
                    <div key={a.name} style={{border:'1px solid var(--border)',borderRadius:12,
                      overflow:'hidden',borderTop:`3px solid ${a.color}`}}>
                      <div style={{padding:'16px 18px'}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:8}}>
                          <div style={{fontFamily:'DM Serif Display,serif',fontSize:15}}>{a.name}</div>
                          <span style={{background:a.color+'18',color:a.color,fontSize:10,
                            padding:'2px 8px',borderRadius:4,fontFamily:'JetBrains Mono,monospace',
                            fontWeight:500,border:`1px solid ${a.color}40`}}>{a.tag}</span>
                        </div>
                        <div style={{fontSize:13,color:'var(--slate)',lineHeight:1.5,marginBottom:12}}>{a.description}</div>
                        <div style={{display:'flex',flexWrap:'wrap',gap:5}}>
                          {a.ops.map(op => (
                            <code key={op} style={{fontSize:10,background:'var(--cream)',
                              padding:'2px 8px',borderRadius:4,
                              fontFamily:'JetBrains Mono,monospace',color:'var(--slate)'}}>
                              {op}
                            </code>
                          ))}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* SCHEMA PAGE */}
          {page==='schema' && (
            <div>
              <div className="section" style={{marginBottom:24}}>
                <div className="section-header">
                  <span className="section-title">Star Schema Design</span>
                  <span className="section-tag">OLAP Foundation</span>
                </div>
                <div className="section-body">
                  <div style={{fontFamily:'JetBrains Mono,monospace',fontSize:13,lineHeight:2,
                    background:'var(--ink)',color:'#a8d8a8',padding:24,borderRadius:10}}>
                    {`                  dim_date
                     │ year · quarter · month
                     │
dim_geography ────── fact_sales ────── dim_product
region · country     │ revenue          category · subcategory
                     │ profit
                dim_customer          cost · quantity
                  customer_segment    profit_margin`}
                  </div>
                </div>
              </div>

              <div style={{display:'grid',gridTemplateColumns:'repeat(2,1fr)',gap:16}}>
                {[
                  { name:'fact_sales', type:'Fact Table', color:'var(--rust)',
                    cols:['sale_id','order_id','date_key','geo_key','product_key','customer_key','quantity','unit_price','revenue','cost','profit','profit_margin'] },
                  { name:'dim_date', type:'Time Dimension', color:'var(--teal)',
                    cols:['date_key','full_date','year','quarter','quarter_num','month','month_name','week_of_year','day_of_week','is_weekend'] },
                  { name:'dim_geography', type:'Geography Dimension', color:'var(--teal)',
                    cols:['geo_key','region','country'] },
                  { name:'dim_product', type:'Product Dimension', color:'var(--teal)',
                    cols:['product_key','category','subcategory'] },
                ].map(t => (
                  <div key={t.name} className="section">
                    <div className="section-header">
                      <span className="section-title">{t.name}</span>
                      <span className="section-tag" style={{color:t.color}}>{t.type}</span>
                    </div>
                    <div className="section-body" style={{padding:'12px 18px'}}>
                      {t.cols.map(c => (
                        <div key={c} style={{fontFamily:'JetBrains Mono,monospace',fontSize:12,
                          padding:'5px 0',borderBottom:'1px solid var(--border)',
                          color:'var(--slate)',display:'flex',justifyContent:'space-between'}}>
                          <span>{c}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>
    </>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
